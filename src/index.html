<!DOCTYPE html>
<html lang="en">
   <head>
    <meta charset="UTF-8">
    <title>KYCManager front-end</title>
    <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="./js/web3.min.js"></script>
    <script language="javascript" type="text/javascript" src="./js/KYCManager_ABI.js"></script>
    <script language="javascript" type="text/javascript" src="./js/KYCNFT_ABI.js"></script>
    
  </head>
  <body>
    <div id="txStatus"></div>
    <input id = "address" placeholder="address">
    <button @click="getBalance()">getBalance</button><br>
    
    <script>
    

     
      var KYCManager;
      var KYCManagerAddress = "0x5D39F07686c6782121Ffc5Cda4f65dE45220Aba9";
      var KYCNFT;
      var KYCNFTAddress = "0xfAe53841d623a35851C00F66742768Cf28B01268";
     
      var web3js = window.web3 ? new Web3(window.web3.currentProvider) : new Web3(new Web3.providers.HttpProvider("https://goerli.infura.io/v3/de1e8657274a494aa59476341cafc010"));
     // var web3js = new Web3(new Web3.providers.HttpProvider("http://127.0.0.1:7545"));
    
      
      function startApp() {
       
        console.log("CurrentProvider: " + web3js.currentProvider.host);
        
        KYCManager = new web3js.eth.Contract(kycManagerABI, KYCManagerAddress);
        
        KYCNFT = new web3js.eth.Contract(kycNFTABI, KYCNFTAddress);
        
        getOwnerOfNFTid(4).then(function(error, result) {
          if(error){
           console.log(error)
         }
         else{
           console.log("OwnerOfNFTid 4: " + JSON.stringify(result));
         }
        });
       
        
        getAccumulatorAddrOfOwner('0xE338401152596583EeC184061F504D7600B59Ea6').then(function(error, result) {
          if(error){
           console.log(error)
         }
         else{
           console.log("AccumulatorAddrOfOwner: " + JSON.stringify(result));
         }
        });
    
       createKYCNFT("ipfs://ipfsHash",userAccount).then(function(error, result) {
         if(error){
           console.log(error)
         }
         else{
           console.log("Success !: " + JSON.stringify(result));
         }
        });
        
      }
      
      
      function getBalance(address){
         web3js.eth.getBalance(address,function(error,result){
         if(error){
           console.log(error)
         }
         else{
           console.log(result)
           
         }
        }) 
      }
      
       
      
  /*
   (1) 创建NFT（ owner权限）
   (2) 设置NFT有效性
  */
      
       function createKYCNFT(tokenUrl, manager) {
        // This is going to take a while, so update the UI to let the user know
        // the transaction has been sent
        $("#txStatus").text("Creating KYCNFT on the blockchain. This may take a while...");
        // Send the tx to our contract:
        return KYCManager.methods.createKYCNFT(tokenUrl, manager)
        .send({ from: userAccount })
        .on("receipt", function(receipt) {
          $("#txStatus").text("Successfully created " + tokenUrl + "for manager" + manager + "!");
        })
        .on("error", function(error) {
          $("#txStatus").text(error);
        });
      }

      
      
      
     /*
     （5）查询某NFT id对应的管理地址与累加器地址
     */
      //由NFTid 找Owner地址
      function getOwnerOfNFTid(id) {
        return KYCManager.methods.ownerOfNFTid(id).call()
      }
      
       //由NFTid 找Accumulator地址
      function getAccumulatorAddrOfNFTID(id) {
        return KYCManager.methods.accumulatorAddrOfNFTID(id).call()
      }
      
      //由Owner 找Accumulator地址
      function getAccumulatorAddrOfOwner(owner) {
        return KYCManager.methods.accumulatorAddrOfOwner(owner).call()
      }
      
       //由NFTid查询有效性
      function getAvailableOfNFTid(id) {
        return KYCManager.methods.availableOfNFTid(id).call()
      }
     



     /*
         Metamask check
     */
    window.addEventListener('load', function() {
     /*   // Checking if Web3 has been injected by the browser (Mist/MetaMask)
        if (typeof window.eth !== 'undefined') {
          web3js = new Web3(web3.currentProvider);
        } else {
          alert('Install Metamask!')
        }*/
        _Connect()
 
        startApp()
      }) 
     
  
    
   function _Connect(){
     //const { web3 } = window
    // const selectedAddress = web3.eth.defaultAccount

    // window.ethereum
    // const accounts = await window.ethereum.request({ method: 'eth_accounts' });

/*
What metamask do is inject javascript into the document when you access it. The browser will execute this javascript, and is that execution that will define de variable web3.

But when you are accessing a document by accessing the file (your url will start with file://) then metamask will not inject the javascript, so the variable web3 will be undefined.

Try accessing your file through a web server of some sort and it will work.*/
   
    if(typeof window.ethereum !== 'undefined') {
          web3 = new Web3(window.ethereum.currentProvider);
          web3.version.getNetwork((err, netId) => {
              switch (netId) {
                case "1":
                    alert('Switch Network');   
                  break
                case "2":
                  console.log('This is the deprecated Morden test network.');
                  alert('Switch Network');
                  break
                case "3":
                    console.log('Connected to the ropsten test network.');
                    web3.eth.defaultAccount = web3.eth.accounts[0];
                    if(!web3.eth.defaultAccount){
                        console.log('Log into metamask');
                        _Connect(callback);
                    }else{ 
                                                    // Success
                        console.log(`Web3 ETH Account: ${web3.eth.defaultAccount}`);
                        alert(false, web3.eth.defaultAccount);
                    }   
                  break
                default:
                  console.log('This is an unknown network.');
                  alert('Switch Network');
              }
            });
        } else {
          console.log(`Failed: Web3 instance required, try using MetaMask.`);
          alert('Install Metamask');
        }   
    }

     
    
    </script>
  </body>
</html>
